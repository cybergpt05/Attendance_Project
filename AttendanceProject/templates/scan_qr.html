{% extends "layout2.html" %}
{% block content %}
<link rel="stylesheet" href="{{url_for('static',filename='login.css')}}">
<script src="https://cdn.jsdelivr.net/npm/@zxing/browser@latest"></script>

<div class="container">
    <div class="card shadow">
        <fieldset class="form-group">
            <center class="fw-bold mb-5" style="font-size: 1.5rem !important;">Scan QR Code</center>
            <div class="form-group">
                <input type="file" id="qrImageInput" class="form-control mb-3" capture="environment" accept="image/*">
                <button id="scanButton" class="btn login-button fw-bold mt-5" style="margin-left: auto; margin-right: auto;">Scan</button>
                <canvas id="qrCanvas" style="display: none;"></canvas>
                <div id="alertDiv" class="alert text-center mt-5" role="alert" hidden></div>
            </div>
        </fieldset>
    </div>
</div>

<script>
    const qrImageInput = document.getElementById('qrImageInput');
    const scanButton = document.getElementById('scanButton');
    const alertDiv = document.getElementById('alertDiv');
    const qrCanvas = document.getElementById('qrCanvas');
    const ctx = qrCanvas.getContext('2d');
    
    // الضغط على زر Scan
    scanButton.addEventListener('click', () => {
        if (qrImageInput.files.length > 0) {
            const file = qrImageInput.files[0];
            compressImage(file, 0.7, 800).then(compressedFile => {
                scanQRCode(compressedFile);
            });
        }
    });

    // ضغط الصورة لتقليل الحجم قبل الإرسال
    function compressImage(file, quality, maxWidth) {
        return new Promise((resolve) => {
            const img = new Image();
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            img.onload = function() {
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                canvas.toBlob(blob => {
                    const compressedFile = new File([blob], file.name, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    });
                    resolve(compressedFile);
                }, 'image/jpeg', quality);
            };
            img.src = URL.createObjectURL(file);
        });
    }

    // استخدام API ZXing لفحص الـ QR code
    function scanQRCode(file) {
        const reader = new ZXing.BrowserQRCodeReader();
        
        const readerConfig = {
            tryHarder: true,
            delayBetweenScanAttempts: 500,
        };

        reader.decodeFromImageUrl(URL.createObjectURL(file), readerConfig)
            .then(result => {
                alertDiv.textContent = `QR Code Scanned: ${result.text}`;
                alertDiv.classList.remove('alert-danger');
                alertDiv.classList.add('alert-success');
                alertDiv.hidden = false;
            })
            .catch(err => {
                alertDiv.textContent = 'Failed to decode QR code. Please try again.';
                alertDiv.classList.remove('alert-success');
                alertDiv.classList.add('alert-danger');
                alertDiv.hidden = false;
                console.error('Error scanning QR code:', err);
            });
    }
</script>

{% endblock %}
