{% extends "layout2.html" %}
{% block content %}
<link rel="stylesheet" href="{{url_for('static',filename='login.css')}}">
<script src="https://cdn.jsdelivr.net/npm/@zxing/browser@latest"></script>

<div class="container">
    <div class="card shadow">
        <fieldset class="form-group">
            <center class="fw-bold mb-5" style="font-size: 1.5rem !important;">Scan QR Code</center>
            <div class="form-group">
                <input type="file" id="qrImageInput" class="form-control mb-3" capture="environment" accept="image/*">
                <button id="scanButton" class="btn login-button fw-bold mt-5" style="margin-left: auto; margin-right: auto;">Scan</button>
                <canvas id="qrCanvas" style="display: none;"></canvas>
                <div id="alertDiv" class="alert text-center mt-5" role="alert" hidden></div>
            </div>
        </fieldset>
    </div>
</div>

<script type="module">
    import { BrowserQRCodeReader } from "https://cdn.jsdelivr.net/npm/@zxing/browser@latest/+esm";

    let selectedImage = null;
    const alertDiv = document.getElementById('alertDiv');

    document.getElementById('qrImageInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            selectedImage = new Image();
            selectedImage.onload = function() {
                showAlert("تم تحميل الصورة بنجاح، اضغط فحص.", "info");
            };
            selectedImage.src = event.target.result;
        };
        reader.readAsDataURL(file);
    });

    document.getElementById('scanButton').addEventListener('click', async function() {
        if (!selectedImage || !selectedImage.complete) {
            showAlert("الرجاء رفع صورة وانتظار تحميلها.", "danger");
            return;
        }

        const canvas = document.getElementById('qrCanvas');
        const ctx = canvas.getContext('2d');

        canvas.width = selectedImage.naturalWidth;
        canvas.height = selectedImage.naturalHeight;
        ctx.drawImage(selectedImage, 0, 0, canvas.width, canvas.height);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const codeReader = new BrowserQRCodeReader();

        try {
            const result = await codeReader.decodeFromCanvas(canvas);
            window.location.href = result.text;
        } catch (error) {
            showAlert("لم يتم العثور على كود QR. تأكد من وضوح الصورة.", "danger");
        }
    });

    function showAlert(message, type) {
        alertDiv.innerHTML = message;
        alertDiv.className = `alert alert-${type} text-center mt-5`;
        alertDiv.hidden = false;
    }
</script>


{% endblock %}
